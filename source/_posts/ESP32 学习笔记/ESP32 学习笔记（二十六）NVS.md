---
title: ESP32 学习笔记（二十六）NVS
date: 2019-04-12 20:33:16
categories:
- ESP32 学习笔记
tags:
- ESP32
---

# NVS - Non-volatile storage

非易失性存储（NVS）库主要用于在闪存中存储键值对。本节介绍 NVS 使用的一些概念。

## 底层存储

目前，NVS 通过 `spi_flash_{read|write|erase}`  API 使用主闪存的一部分。该库使用具有 data 类型和 nvs 子类型的所有分区。应用程序可以通过 `nvs_open` API 选择使用带有标签 nvs 的分区或通过 `nvs_open_from_part` API 使用指定名称的任意分区。

>如果 NVS 分区被截断（例如，更改分区表布局时），则应擦除其内容。ESP-IDF 构建系统提供 `make erase_flash` 以擦除闪存芯片的所有内容。

>NVS 最适合存储许多小值，而不是 “string” 和 “blob” 类型的大值。如果需要存储大的 blob 或字符串，请考虑使用在损耗均衡库之上的 FAT 文件系统提供的功能。

<!--more-->

## 键值对

NVS 在键值对上操作。键是 ASCII 字符串，最大键长度当前为 15 个字符。值可以具有以下类型之一：
 - 整形: uint8_t, int8_t, uint16_t, int16_t, uint32_t, int32_t, uint64_t, int64_t
 - 以0结尾的字符串
 - 可变长的二进制数据(blob)

>字符串值目前限制为 4000 字节。这包括空终止符。Blob 值限制为 508000 字节或（分区大小的 97.6％- 4000）字节，以较低者为准。

键必须是唯一的。为已存在的键写入值的行为如下：
 - 如果新值相同，则更新值
 - 如果新值与旧值的数据类型不同，则返回错误

读取值时也会执行数据类型检查。如果读取操作的数据类型与值的数据类型不匹配，则返回错误。

## 命名空间

为了缓解不同组件之间键名称中的潜在冲突，NVS 将每个键值对分配给一个命名空间。命名空间名称遵循与键名相同的规则，即最多15个字符的长度。命名空间名称在 `nvs_open` 或 `nvs_open_from_part` 调用中指定。此调用返回一个不透明句柄，该句柄用于后续调用 `nvs_read_ *`，`nvs_write_ *` 和 `nvs_commit` 函数。这样，handle 与命名空间相关联，并且键名不会与其他命名空间中的相同名称冲突。 请注意，不同 NVS 分区中具有相同名称的命名空间被视为单独的命名空间。

## 安全性

NVS 与 ESP32 闪存加密系统不直接兼容。然而，如果 NVS 加密与 ESP32 闪存加密一起使用，数据仍可以加密形式存储。

## 内部

### 键值对的日志

NVS 按顺序存储键值对，新的键值对添加在最后。当必须更新任何给定密钥的值时，在日志的末尾添加新的键值对，并将旧的键值对标记为已擦除。

### 页面和条目

NVS 库在其操作中使用两个主要实体：页面和条目。Page 是一个逻辑结构，用于存储整个日志的一部分。逻辑页面对应于闪存的一个物理扇区。正在使用的页面具有与之关联的序列号。序列号在页面上强制排序。较高的序列号对应于稍后创建的页面。

### 页面结构

页面由三部分组成：标题，条目状态位图和条目本身。要与 ESP32 闪存加密兼容，条目大小为 32 个字节。对于整数类型，条目包含一个键值对。对于字符串和 blob，条目包含键值对的一部分。

### 条目状态位图和条目

每个条目可以处于以下三种状态之一。每个状态在入口状态位图中用两位表示。位图中的最后四位（256-2 * 126）未使用。

- 空（2'b11）
- 被写（2'b10）
- 删除（2'b00）

### 条目结构

对于基本类型的值（当前长度为 1 到 8 个字节的整数），条目包含一个键值对。对于字符串和 blob 类型，条目包含整个键值对的一部分。对于字符串，如果键值对跨越多个条目，则所有条目都存储在同一页面中。通过将 Blob 划分为更小的块，允许Blob跨越多个页面。为了跟踪这些块，存储称为“blob 索引”条目的附加固定长度元数据条目。早期格式的 blob 仍然受支持（可以读取和修改）。但是，一旦修改了blob，就会使用新格式存储它们。

可变长度值（字符串和 blob）写入后续条目，每个条目 32 个字节。第一个条目的 Span 字段表示使用了多少条目。

### 命名空间

如上所述，每个键值对属于一个名称空间。命名空间标识符（字符串）存储为名称空间中键值对的键，索引为0。与这些键对应的值是这些命名空间的索引。

## 参考资料

 - [Non-volatile storage library](https://docs.espressif.com/projects/esp-idf/en/v3.2/api-reference/storage/nvs_flash.html)
